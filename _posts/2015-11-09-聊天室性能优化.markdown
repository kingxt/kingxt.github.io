---
layout: post
title: "èŠå¤©å®¤æ€§èƒ½ä¼˜åŒ–"
date: 2015-11-11
author: "KingXt"
tags: 
    - iOS
---

### [è¶…ä¿¡](https://itunes.apple.com/cn/app/chao-xin/id1013692970?l=en&mt=8)èŠå¤©å®¤æ€§èƒ½ä¼˜åŒ–

èŠå¤©å®¤æ€§èƒ½æ˜¯å³æ—¶é€šè®¯Appä½“éªŒè‡³å…³é‡è¦çš„ä¸€ç‚¹ï¼Œå¾®ä¿¡å¤§å®¶ç”¨å¾—å¤šï¼Œæ€ä¹ˆè¾¾åˆ°å¾®ä¿¡èŠå¤©å®¤çš„æµç•…åº¦ï¼Œæˆ–è€…è¯´æ€ä¹ˆè¶…è¿‡å¾®ä¿¡èŠå¤©å®¤èŠå¤©å®¤æ€§èƒ½äº†ï¼Ÿæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆè€æ¿æŠŠæˆ‘ä»¬è¿™ä¸ªAppå–åè¶…ä¿¡ï¼Œè¶…è¶Šå¾®ä¿¡ğŸ˜„ï¼Ÿè¿™ç‚¹éš¾åšåˆ°ï¼Œä¹Ÿä¸æ˜¯ä½œä¸ºä¸€ä¸ªç å†œå…³æ³¨çš„ï¼Œæˆ‘ç›¸ä¿¡æŸäº›æŠ€æœ¯æ–¹é¢å¯ä»¥è¶…è¶Šå¾®ä¿¡ã€‚

è¶…ä¿¡èŠå¤©å®¤æ€§èƒ½æ–¹é¢ä¸é”™äº†ï¼Œæˆ‘åˆ†äº«ä¸‹æˆ‘å¯¹èŠå¤©å®¤æ€§èƒ½ä¼˜åŒ–å‡ ä¸ªç»éªŒã€‚

èŠå¤©å®¤é‡Œé¢ä¸»è¦æ˜¯æ–‡å­—åå¤šï¼Œæ€ä¹ˆåšåˆ°æ–‡å­—å¤šï¼Œå›¾æ–‡æ··æ’ï¼Œå„ç§ä¹±ä¸ƒå…«ç³Ÿéœ€æ±‚æƒ…å†µä¸‹èƒ½è¾¾åˆ°60fpsäº†ï¼Œæ¯”å¦‚èŠå¤©å®¤è¦æ”¯æŒè¶…é“¾æ¥æƒ…å†µä¸‹è¿˜éœ€è¦æ”¯æŒè¶…é“¾æ¥é¢„è§ˆï¼Œæ”¯æŒè¶…æ—¶é—´æˆ³appendåˆ°æ¶ˆæ¯åç¼€ã€‚

<img src="/img/post/IMG_2724.PNG" with="200" height="250"/>

ä¸ºäº†å®ç°åŠŸèƒ½åŒæ—¶ä¸å½±å“Appæµç•…åº¦ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡ç¼“å­˜å¯Œæ–‡æœ¬å®ç°ï¼Œæˆ‘ä»¬éœ€è¦ç¼“å­˜å¯Œæ–‡æœ¬ç»˜åˆ¶çš„æ¯è¡Œæ–‡æœ¬å†…å®¹ï¼Œè¿™æ ·åœ¨æ»šåŠ¨æ—¶å€™åªéœ€è¦ç»˜åˆ¶æ–‡æœ¬å³å¯ã€‚

``` objc

@interface SLReusableLabelLayoutData : NSObject
@property(nonatomic) CGSize size;
@property(nonatomic, strong) NSArray *textLines;
@property(nonatomic) CGSize drawingSize;
@property(nonatomic) float lastLineWidth;
@property(nonatomic) float additionalHeight;
#ifdef __cplusplus
- (std::vector<SLLinkData> *)links;
- (std::vector<SLLinePosition> *)lineOrigins;
- (std::vector<SLRunAttachment *> *)runAttachment;
- (SLLinkData *)linkAtPoint:(CGPoint)point;
#endif

@end

typedef NS_ENUM(NSInteger, SLReusableLabelLayout) {
    SLReusableLabelLayoutMultiline = 1,
    SLReusableLabelLayoutHighlightLinks = 1 << 1,
    SLReusableLabelLayoutDateSpacing = 1 << 2,
    SLReusableLabelLayoutExtendedDateSpacing = 1 << 3
};

@interface SLRichTextHelper : NSObject

+ (SLReusableLabelLayoutData *)calculateLayout:(NSString *)text
                                          font:(UIFont *)font
                                     textColor:(UIColor *)textColor
                                         frame:(CGRect)frame
                                    orMaxWidth:(float)maxWidth
                                         flags:(SLReusableLabelLayout)flags
                                 textAlignment:(NSTextAlignment)textAlignment
                       additionalTrailingWidth:(CGFloat)additionalTrailingWidth
                                         style:(void (^)(NSMutableAttributedString *string, NSMutableArray *textCheckingResults))style;

@end
```

ä¸Šé¢æ˜¯æ–‡æœ¬æ¸²æŸ“ç¼“å­˜ç±»æ¥å£ï¼ŒUILableå¯ä»¥é‡å†™`- (void)drawRect:(CGRect)rect` æ–¹æ³•ï¼Œç›´æ¥ç”¨è¿™ä¸ªLayoutDataå¸ƒå±€ï¼Œè€Œä¸éœ€è¦é‡æ–°å¸ƒå±€æ–‡æœ¬ã€‚è‡ªå·±çœ‹è¿™ä¸ªæ¥å£çš„é‡Œé¢çš„å±æ€§ï¼Œæœ‰ä¸€äº›æ˜¯é€šè¿‡c++çš„classå’Œstructä¿å­˜æ•°æ®ï¼Œè¿™ä¸ªæ˜¯è¦é—®NSObject newè¦å¼€è¾Ÿé¢å¤–çš„å¯¹æˆ‘ä»¬æ²¡æœ‰ç”¨çš„ç©ºé—´ä¿å­˜mediateå…ƒæ•°æ®ã€‚è€Œæˆ‘ä»¬çš„Lineï¼Œæˆ–è€…Line Positionæ•°æ®é‡å¤§ï¼Œæ²¡å¿…è¦å¼€è¾Ÿè¿™äº›é¢å¤–ç©ºé—´ã€‚

è¿›å…¥èŠå¤©å®¤ï¼Œä¼šä»æ•°æ®åº“æˆ–è€…Serveræ‹‰å–å†å²æ¶ˆæ¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šæœ‰ä¸€å¤§å †é€»è¾‘éœ€è¦å¤„ç†ï¼Œåœ¨æ¸²æŸ“åˆ°UIå‰è¿˜éœ€è¦è®¡ç®—è¡Œé«˜ï¼Œæ˜¾ç¤ºèŠå¤©å®¤æ¶ˆæ¯æˆ‘å»ºè®®ç”¨UICollectionViewè€Œä¸æ˜¯UITableViewï¼Œä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¿™ä¸ªå¯å®šåˆ¶æ€§å¼ºï¼Œä½ è¦çŸ¥é“ï¼Œé¡¹ç›®ç»ç†çš„æƒ³è±¡åŠ›æ˜¯ååˆ†ä¸°å¯Œçš„ï¼Œä¸ºäº†è¾¾åˆ°ä»–ä»¬çš„éœ€æ±‚ï¼ŒUITableViewå¯èƒ½ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚æˆ‘ä»¬ä¸ºæ¯ä¸€ç±»æ¶ˆæ¯ä¸€ç§Renderï¼Œæ ¹æ®ä¸åŒçš„æ¶ˆæ¯ç±»å‹æ„å»ºä¸åŒçš„Renderï¼Œè€Œä¸è¦é€šè¿‡æ‰€æœ‰çš„æ¶ˆæ¯ä¸€ä¸ªç±»å‹Renderï¼Œé€šè¿‡éšè—æ˜¾ç¤ºæ¥Reusable Cellï¼Œç»™æ¯ç§ç±»å‹æ¶ˆæ¯ä¸€ä¸ªç‹¬ç«‹çš„Identifierï¼Œé€šè¿‡ç±»ä¼¼å¦‚ä¸‹æ–¹æ³•æ³¨å†Œ

``` objective-c
+ (void)registeResuableCells:(UICollectionView *)collectionView {
    [collectionView registerClass:[SLTimeRender class] forCellWithReuseIdentifier:NSStringFromClass(SLChatTimeMessage.class)];
    [collectionView registerClass:[SLChatSystemMessageRender class] forCellWithReuseIdentifier:NSStringFromClass(SLChatSystemMessage.class)];
    [collectionView registerClass:[SLUnknownMessageRender class] forCellWithReuseIdentifier:kUnknownMessageRenderIdentifer];
    [collectionView registerClass:[SLOutgoingTextMessageRender class] forCellWithReuseIdentifier:[NSString stringWithFormat:kTextMessageRenderIdentiferFormat, kIncoming]];
    [collectionView registerClass:[SLIncomingTextMessageRender class] forCellWithReuseIdentifier:[NSString stringWithFormat:kTextMessageRenderIdentiferFormat, kOutgoing]];
    ...
}
```

åœ¨Renderé‡Œé¢å¯ä»¥é€šè¿‡Auto layoutå¸ƒå±€ï¼Œè¿™æ ·è§£å†³äº†iPhoneï¼Œipadé€‚é…å¤§éƒ¨åˆ†é—®é¢˜ã€‚

ä¸ºäº†ä½¿è¿›å…¥èŠå¤©å®¤æ›´å¿«ï¼Œåœ¨èŠå¤©å®¤é‡Œé¢å‘ä¸Šæ»šåŠ¨æ›´é¡ºç•…ï¼Œè€Œä¸æ˜¯åƒå¾®ä¿¡é‚£æ ·æ»šåŠ¨åˆ°æœ€ä¸Šé¢è¿˜è¦ç­‰å‡ ç§’ï¼Œæˆ‘ä»¬é‡‡å–çš„ç­–ç•¥æ˜¯åœ¨æ»šåŠ¨æ¡å¿«åˆ°é¡¶éƒ¨ï¼ˆoffset < 300ï¼‰æ—¶å€™å¼‚æ­¥æå‰å–æ•°æ®ï¼Œç­‰æ•°æ®å–å›æ¥åï¼Œæå‰å°†æ¶ˆæ¯é•¿åº¦è®¡ç®—å¥½ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥å……åˆ†åˆ©ç”¨å¹¶è¡Œè®¡ç®—ã€‚

``` objective-c
NSMutableArray<SLUITextMessageContentImpl *> *willCalculateMessages = [NSMutableArray new];
    for (id<SLMessage> message in self.allMessages) {
      	//å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯æ–‡æœ¬æ¶ˆæ¯
        if ([SLMessageOpinion isTextMessage:message]) {
            SLUITextMessageContentImpl *content = (SLUITextMessageContentImpl *)[message getContent];
            if (![content hasLayoutData]) {
                [willCalculateMessages addObject:content];
            }
        }
    }
    dispatch_apply(willCalculateMessages.count, dispatch_get_global_queue(0, 0), ^(size_t index) {
      //è®¡ç®—æ¯ä¸ªæ–‡æœ¬æ¶ˆæ¯çš„layout
        [willCalculateMessages[index] layoutData];
    });
```

