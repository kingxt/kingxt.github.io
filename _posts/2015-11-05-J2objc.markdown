--- 
layout:     post		
title:      "J2objc"		
date:       2015-11-05	
author:     "KingXt"		
tags:
    - iOS
    - j2obc
---

# J2objc 

------

### å¦‚ä½•åˆ æ‰ä¸æƒ³åŠ å…¥åˆ° `libjar_emul` ç¼–è¯‘æ–‡ä»¶ä¸­
åœ¨java_sources.mkä¸­åˆ æ‰ä¸æƒ³åŠ å…¥ç¼–è¯‘çš„ç±»

###æ­å»º j2objc ç¯å¢ƒï¼Œ
- Macæ­å»ºmvnç¯å¢ƒï¼Œå…·ä½“æ­¥éª¤å¯ä»¥å‚è€ƒ http://www.journaldev.com/2348/how-to-install-maven-on-mac-os-x-mavericks-10-9
- git cloneä¸‹æ¥https://github.com/google/j2objc, æˆ–è€…è‡ªå·±forkä¸€ä¸ªrepository
- translatoræ˜¯javaè½¬ocçš„ç¿»è¯‘å™¨ï¼Œå°†æ­¤é¡¹ç›®å¯¼å…¥å·¥ç¨‹ï¼Œå¯¼å…¥åä½ ä¼šå‘ç°ä¸€å¤§å †ç¼–è¯‘é”™è¯¯ï¼Œåˆ«æ…Œï¼Œåˆ°translatorç›®å½•ä¸‹é¢çš„java_depså­ç›®å½•é‡Œé¢mvn installï¼Œè¿™æ—¶å€™mvnå°†ç»™ä½ ä¸‹è½½ä¾èµ–åŒ…ï¼Œå°†è¿™äº›åŒ…å¯¼å…¥eclipseå·¥å…·å³å¯ã€‚
- è‡ªå·±ç¼–è¯‘j2objcï¼Œåœ¨translatorç›®å½•ä¸‹é¢make clean, make dist

###J2objcä½¿ç”¨æ³¨æ„äº‹é¡¹
å¤§éƒ¨åˆ†äººè®¤ä¸ºjavaä»£ç è½¬åˆ°ocä»£ç ä¸é è°±ï¼Œæˆ‘ä»0.5è¿™ä¸ªç‰ˆæœ¬å°±ä½¿ç”¨è¿™ä¸ªåº“ï¼ŒæœŸé—´ä¹Ÿè¢«è¿™ä¸ªåº“å‘è¿‡ï¼Œä¸è¿‡å¦‚æœä½ ç†Ÿæ‚‰javaå’Œocçš„è¯ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±é¡¹ç›®éœ€æ±‚å®šåˆ¶ç¿»è¯‘å™¨ï¼Œæˆ–è€…ç»•è¿‡æœ‰å‘çš„åœ°æ–¹ï¼Œæˆ‘è¯´å‡ ä¸ªæˆ‘æ›¾ç»é‡åˆ°çš„å‘

 1ã€ Javaçš„Annotationç¿»è¯‘åˆ°OCæœ‰æ€§èƒ½é—®é¢˜ï¼Œå¯¹javaç†Ÿæ‚‰çš„äººéƒ½æ˜¯çŸ¥é“javaçš„annotationååˆ†å¼ºå¤§ï¼Œä½†æ˜¯object-cæ˜¯ä¸æ”¯æŒæ³¨è§£çš„ï¼Œä¸ºäº†å®ç°æ”¯æŒæ³¨è§£ï¼Œgoogleå·¥ç¨‹å¸ˆä»¬æƒ³åˆ°äº†ä¸€ä¸ªæ–¹æ³•å°±æ˜¯å°†æ³¨è§£å¼„æˆmedidateï¼Œä¸‹é¢è´´ä¸€æ®µä»£ç åˆ†æä¸‹ï¼š
 
```java 
@Subscribe
public void handle(final SocketInboundClearMessagesPacketData data)
{
}
    
``` 

ä¸Šé¢è¿™æ®µä»£ç é€šè¿‡j2obcç¿»è¯‘è¿‡æ¥å¦‚ä¸‹ï¼š

```objc
+ (IOSObjectArray *)__annotations_handleWithSLSocketInboundClearMessagesPacketData_ {
  return [IOSObjectArray arrayWithObjects:(id[]) { [[ComGoogleCommonEventbusSubscribe alloc] init] } count:1 type:JavaLangAnnotationAnnotation_class_()];
}

- (void)handleWithSLSocketInboundClearMessagesPacketData:(id<SLSocketInboundClearMessagesPacketData>)data {
}

```
   å®ç°æ€æƒ³å¾ˆç®€å•ï¼Œç»™æ–¹æ³•æ³¨è§£ä¸€å®šçš„æè¿°ï¼Œæ¯”å¦‚ä¸Šé¢ä»£ç ç¿»è¯‘è¿‡æ¥çš„__annotations_*ï¼Œå½¢æˆä¸€ä¸ªåŒ¹é…è§„åˆ™å³å¯è¾¾åˆ°java annotationç›®çš„ã€‚ä½†æ˜¯æˆ‘å½“æ—¶å€™å®ç°ä¸€ä¸ªjavaåå°„+annotationæ ¹æ®ç½‘ç»œè¯·æ±‚ç”Ÿæˆjavabeanï¼Œæˆ‘æµ‹è¯•äº†Javabeanç”Ÿæˆæ—¶é—´ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªå‘ï¼Œç›¸å½“è€—æ—¶ï¼Œå»ºè®®ä¸è¦è¿‡å¤šä¾èµ–annotationã€‚è¿™ä¸»è¦åŸå› æ˜¯iOSæ²¡æœ‰javaè¿™ç§annotationæœºåˆ¶ï¼Œåªèƒ½æ›²çº¿æ•‘å›½ï¼Œä¸­é—´ç”¨äº†å¾ˆå¤šocçš„runtimeç‰¹æ€§ã€‚

2ã€javaå’ŒOCæ€ä¹ˆé€šè®¯äº†

 - é€šè¿‡iOSè‡ªå¸¦çš„NotificationCenter
è¿™ç§æ–¹å¼å¾ˆæˆç†Ÿï¼Œä½†æ˜¯åœ¨javaç«¯ä¸å…¼å®¹ï¼Œjavaé€šè¿‡éœ€è¦å¤„ç†å¾ˆå¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œä¸šåŠ¡ç±»ä¹‹é—´é€šè®¯æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥è‡ªå·±é€šè¿‡å†™MessageListenerManagerå¸¸ç”¨åšæ³•å®ç°ã€‚æˆ‘å‚ä¸è¿‡çš„ä¸¤ä¸ªå³æ—¶é€šè®¯é¡¹ç›®ï¼ˆèŠèŠï¼Œè¶…ä¿¡ï¼‰æ˜¯é€šè¿‡Event Buså®ç°
 - é€šè¿‡guavaçš„Event Busé€šè®¯
guavaçš„Event Busæ˜¯é€šè¿‡æ³¨è§£+åå°„å®ç°ï¼Œåˆšå¼€å§‹è¿˜å¾ˆæ€€ç–‘guavaæ€§èƒ½ï¼Œæˆ‘å†™äº†ä¸€ä¸ªæµ‹è¯•demoï¼Œå‘ç°ä¸€æ¬¡eventçš„ç®€å†åˆ°æ´¾å‘æ¥å—ä¸€èˆ¬éƒ½æ˜¯1-2msï¼Œè¿™ä¸ªæ˜¯èƒ½æ¥å—çš„ï¼ŒiOSè‡ªå¸¦çš„NotificationCenterä¸€èˆ¬éƒ½éœ€è¦8msæ´¾å‘æ¥å—æ—¶é—´ï¼Œæ­¤æ—¶æˆ‘å¾ˆæ€€ç–‘è¿™ä¸ªç»“è®ºï¼Œç„¶åæˆ‘ç ”ç©¶guava EventBusçš„æºç ï¼Œé‡Œé¢çš„å®ç°æ˜¯å¯¹å›è°ƒæœ‰ä¸€å¥—ç¼“å­˜æœºåˆ¶ï¼Œå¯»æ‰¾Post çš„Subscribeéå¸¸å¿«ï¼Œä½†æ˜¯é—®é¢˜æ¥äº†ï¼Œæˆ‘ä»¬è‡ªå·±å†™çš„OCç±»æ€ä¹ˆæ‰®æ¼”Subscribeè§’è‰²äº†ï¼Ÿ

æˆ‘çš„è§£å†³æ–¹æ¡ˆå†™ä¸€ä¸ªæ¯ä¸ªViewControlleræœ‰ä¸€ä¸ªCompanioné€»è¾‘å¤„ç†ç±»ï¼Œè¿™ä¸ªé€»è¾‘å¤„ç†ç±»éƒ½æ´¾ç”Ÿè‡ªä¸€ä¸ªEventHandleç±»

```objc
#import <Foundation/Foundation.h>
#include "IOSClass.h"
#include "J2ObjC_source.h"
#include "com/google/common/eventbus/Subscribe.h"
#include "com/google/common/eventbus/EventBus.h"

void removeEventBusUnBindSubscribe();

#define CREATE_ANNOTATONS_FUNC(TYPE, FUNC) \
+ (IOSObjectArray *)__annotations_##FUNC##With##TYPE##_ \
{                                       \
    return [IOSObjectArray arrayWithObjects:(id[]) { [[ComGoogleCommonEventbusSubscribe alloc] init] } count:1 type:JavaLangAnnotationAnnotation_class_()];                         \
}                                       \
                                        \
- (void) FUNC##With##TYPE:(id)data  \
{                                       \
    [self FUNC:data];                 \
}


#define CREATE_CONTROLLER_COMPANION_INIT(TYPE) \
- (instancetype)initWith##TYPE:(TYPE *)controller;

#define CREATE_CONTROLLER_COMPANION_IMPL(TYPE) \
{\
    __weak TYPE *_controller; \
}\
- (instancetype)initWith##TYPE:(TYPE *)controller { \
    self = [self init]; \
    if (self) { \
        _controller = controller; \
    } \
    return self; \
}\
- (BOOL)isInvalid:(NSObject *)referObj { \
    return (_controller == nil || _controller == referObj); \
}

@interface SLJavaEventHandle : NSObject

@property (nonatomic, weak) ComGoogleCommonEventbusEventBus *eventBus;
- (BOOL)isInvalid:(NSObject *)referObj;

@end

@interface ComGoogleCommonEventbusEventBus (Tracking)

@end
```

ä¸‹é¢æ˜¯å®ç°

```objc

#import "SLJavaEventHandle.h"

static NSMutableArray<SLJavaEventHandle *> *_subscribeManager;

void removeEventBusUnBindSubscribe(NSObject *bind) {
    if (_subscribeManager) {
        for (SLJavaEventHandle *handle in [_subscribeManager copy]) {
            if ([handle isInvalid:bind]) {
                [handle.eventBus unregisterWithId:handle];
                handle.eventBus = nil;
            }
        }
    }
}

@implementation SLJavaEventHandle

- (BOOL)isInvalid:(NSObject *)referObj {
    return NO;
}

@end

@implementation ComGoogleCommonEventbusEventBus (Tracking)

+ (void)load {
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        Class class = [self class];
        
        SEL originalRegisterSelector = @selector(register__WithId:);
        SEL swizzledRegisterSelector = @selector(new_register__WithId:);
        
        SEL originalUnRegisterSelector = @selector(unregisterWithId:);
        SEL swizzledUnRegisterSelector = @selector(new_unregisterWithId:);
        
        Method originalRegisterMethod = class_getInstanceMethod(class, originalRegisterSelector);
        Method swizzledRegisterMethod = class_getInstanceMethod(class, swizzledRegisterSelector);
        
        Method originalUnRegisterMethod = class_getInstanceMethod(class, originalUnRegisterSelector);
        Method swizzledUnRegisterMethod = class_getInstanceMethod(class, swizzledUnRegisterSelector);
        
        
        BOOL didAddRegisgerMethod =
        class_addMethod(class,
                        originalRegisterSelector,
                        method_getImplementation(swizzledRegisterMethod),
                        method_getTypeEncoding(swizzledRegisterMethod));
        
        if (didAddRegisgerMethod) {
            class_replaceMethod(class,
                                swizzledRegisterSelector,
                                method_getImplementation(originalRegisterMethod),
                                method_getTypeEncoding(originalRegisterMethod));
        } else {
            method_exchangeImplementations(originalRegisterMethod, swizzledRegisterMethod);
        }
        
        BOOL didAddUnRegisgerMethod =
        class_addMethod(class,
                        originalUnRegisterSelector,
                        method_getImplementation(swizzledUnRegisterMethod),
                        method_getTypeEncoding(swizzledUnRegisterMethod));
        
        if (didAddUnRegisgerMethod) {
            class_replaceMethod(class,
                                swizzledUnRegisterSelector,
                                method_getImplementation(originalUnRegisterMethod),
                                method_getTypeEncoding(originalUnRegisterMethod));
        } else {
            method_exchangeImplementations(originalUnRegisterMethod, swizzledUnRegisterMethod);
        }
    });
}

- (void)new_register__WithId:(id)subscribe {
    [self new_register__WithId:subscribe];
    if (!_subscribeManager) {
        _subscribeManager = [NSMutableArray array];
    }
    if (subscribe && [subscribe isKindOfClass:[SLJavaEventHandle class]]) {
        ((SLJavaEventHandle *)subscribe).eventBus = self;
        [_subscribeManager addObject:subscribe];
    }
}

- (void)new_unregisterWithId:(id)subscribe {
    [self new_unregisterWithId:subscribe];
    if (subscribe && _subscribeManager && [subscribe isKindOfClass:[SLJavaEventHandle class]]) {
        ((SLJavaEventHandle *)subscribe).eventBus = nil;
        [_subscribeManager removeObject:subscribe];
    }
}

@end

```

å¤§è‡´çš„æ€è·¯æ˜¯é€šè¿‡swizzleè§£å†³Event Buså¼ºåº”ç”¨å¯¼è‡´Companionå†…å­˜æ³„éœ²é—®é¢˜ï¼Œé€šè¿‡å®æä¾›æ³¨è§£æ³¨å…¥é€»è¾‘æ–¹å¼ï¼Œä¸šåŠ¡é€»è¾‘åªè¦æ´¾ç”Ÿè‡ªè¿™ä¸ªç±»ï¼Œå†™è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘å³å¯ï¼Œç±»ä¼¼å¦‚ä¸‹demo

```objc
@interface SLMessageViewCompanion()

@end

@implementation SLMessageViewCompanion
CREATE_CONTROLLER_COMPANION_IMPL(SLMessageViewController)

CREATE_ANNOTATONS_FUNC(SLRemovePrivateChatMessageEvent, onRemovePrivateChatMessageEvent);
- (void)onRemovePrivateChatMessageEvent:(id<SLRemovePrivateChatMessageEvent>)data {
    [_controller resetConversation];
}

CREATE_ANNOTATONS_FUNC(SLClearPrivateChatMessagesEvent, onClearPrivateChatMessagesEvent);
- (void)onClearPrivateChatMessagesEvent:(id<SLClearPrivateChatMessagesEvent>)data {
    [_controller resetConversation];
}

CREATE_ANNOTATONS_FUNC(SLRemoveGroupChatMessageEvent, onRemoveGroupChatMessageEvent);
- (void)onRemoveGroupChatMessageEvent:(id<SLRemoveGroupChatMessageEvent>)data {
    [_controller resetConversation];
}

CREATE_ANNOTATONS_FUNC(SLClearGroupChatMessagesEvent, onClearGroupChatMessagesEvent);
- (void)onClearGroupChatMessagesEvent:(id<SLClearGroupChatMessagesEvent>)data {
    [_controller resetConversation];
}

@end
```

æœªå®Œå¾…ç»­ğŸ˜Š